# Apache Shiro配置

Shiro设计成可用于任何环境，小到简单的命令行应用程序，大到复杂的企业集群应用程序。由于环境的多样性，可以使用多种配置机制来对Shiro进行配置。本章节仅仅讲述Shiro核心支持的配置机制。

> :heavy_check_mark: 诸多配置项

> Shiro的`SecurityManager`实现类和所有支持组件都是与JavaBean兼容的。这就允许Shiro可以使用任务的配置格式进行配置，如XML（Spring、JBoss、Guice等）、[YAML](http://www.yaml.org/)、JSON、Groovy Builder标识语言等等。

## 程序化配置

创建和使用`SecurityManager`最简单的方法就是实例化`org.apache.shiro.mgt.DefaultSecurityManager`类。例如：

```Java
Realm realm = //instantiate or acquire a Realm instance.  We'll discuss Realms later.
SecurityManager securityManager = new DefaultSecurityManager(realm);

//Make the SecurityManager instance available to the entire application via static memory:
SecurityUtils.setSecurityManager(securityManager);
```

惊奇吧，仅仅3行代码，就创建了一个功能齐全的Shiro环境了。就是这么简单！

### SecurityManager内部对象

正如在[架构](./1.3.Architecture-架构.md)章节里描述的，Shiro的`SecurityManager`的实现实质上是内嵌了很多模块化的安全组件对象的。因为他们是JavaBean兼容的，您可以通过内嵌组件的`getter`和`setter`方法来定制`SecurityManager`。

例如，若想使用自定义的`SessionDAO`来定制[会话管理](https://shiro.apache.org/session-management.html)，可以使用内嵌在`SecurityManager`的`setSessionDAO`方法来设置`SessionDAO`：

```Java
...

DefaultSecurityManager securityManager = new DefaultSecurityManager(realm);

SessionDAO sessionDAO = new CustomSessionDAO();

((DefaultSessionManager)securityManager.getSessionManager()).setSessionDAO(sessionDAO);
...
```

直接使用方法调用，可以配置`SecurityManager`里内置的所有对象。

但是，尽管程序化配置很简单，在实际的项目里它却不是理想的配置机制。程序化配置不适合的几个原因：

* 您必须知道实现类的具体实现细节。然而更好的做法是您不用关心具体的实现细节，也不用知道从哪里得到它们。

* 由于Java的类型安全特性，您必须对通过`get*`获取的对象进行强类型转换。那么多的强类型转换是超级恶心、累赘并且跟具体的实现类紧耦合。

* `SecurityUtils.setSecurityManager`方法会将`SecurityManager`实例化对象作为JVM静态单例，在大多数应用程序中没什么问题，但如果有多个使用Shiro的程序在同一个JVM中运行时，各自程序有自己独立的实例会更好些，而不是共同引用一个静态单例。

* 每次的配置更改，您都要重新编译您的应用程序。

尽管有这些不足，直接程序化配置在内存受限的环境里还是很有用的，如智能手机应用程序中就很有用。若您的应用程序不是在内存受限的环境中运行的，您会发现基于文件的配置机制可用性和可读性都更强。

## INI配置机制

绝大多数应用程序都可以使用基于文本的配置机制，这种配置可以在源代码之外进行更改，甚至连Shiro的API都不太熟悉的使用者都可以很容易理解这种配置。

为了确保这种基于文本的配置机制可以在所有的环境中使用，尽可能减少对第三方的依赖，Shiro支持[INI格式](https://en.wikipedia.org/wiki/INI_file)来构建`SecurityManager`内嵌对象及其支持的组件。INI易于阅读，易于配置，易于创建，适合大多数应用。

### 使用INI配置SecurityManager

下面是两个基于INI配置构建SecurityManager的例子。

#### 使用INI资源创建SecurityManager

可以使用INI资源路径进行实例化`SecurityManager`。资源可以通过文件系统（前缀为`file:`）、类路径（前缀为`classpath:`）或者URL（前缀为`url:`）获得。下面的例子使用一个`Factory`从类路径根目录加载`shiro.ini`，并获取到一个`SecurityManager`实例。

```java
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.util.Factory;
import org.apache.shiro.mgt.SecurityManager;
import org.apache.shiro.config.IniSecurityManagerFactory;

...

Factory<SecurityManager> factory = new IniSecurityManagerFactory("classpath:shiro.ini");
SecurityManager securityManager = factory.getInstance();
SecurityUtils.setSecurityManager(securityManager);
```

#### 使用INI实例创建SecurityManager

还可以通过`org.apache.shiro.config.Ini`类使用编程方式来构造INI配置。Ini类的功能和JDK的`java.util.Properties`类似，但还支持按节名进行分段。

例如：

```java
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.util.Factory;
import org.apache.shiro.mgt.SecurityManager;
import org.apache.shiro.config.Ini;
import org.apache.shiro.config.IniSecurityManagerFactory;

...

Ini ini = new Ini();
//populate the Ini instance as necessary
...
Factory<SecurityManager> factory = new IniSecurityManagerFactory(ini);
SecurityManager securityManager = factory.getInstance();
SecurityUtils.setSecurityManager(securityManager);
```

至此，我们已知道如何使用INI配置来构造一个`SecurityManager`实例，那么让我们来看看如何定义一个Shiro的INI配置吧。

### INI剖析

INI基于文本格式进行配置，在独立命名的区段（sections）内通过成对的键/值对组成。键仅在每个区段（section）是唯一的，但在整个配置文件中并不需要唯一（这点跟JDK的[Properties](http://java.sun.com/javase/6/docs/api/java/util/Properties.html)不同）。不过，每个区段（section）可以看成是一个独立的`Properties`定义。

注释行可以用“#”或“;”标识。

以下是Shiro支持的section示例：

```ini
# =======================
# Shiro INI configuration
# =======================

[main]
# Objects and their properties are defined here,
# Such as the securityManager, Realms and anything
# else needed to build the SecurityManager

[users]
# The 'users' section is for simple deployments
# when you only need a small number of statically-defined
# set of User accounts.

[roles]
# The 'roles' section is for simple deployments
# when you only need a small number of statically-defined
# roles.

[urls]
# The 'urls' section is used for url-based security
# in web applications.  We'll discuss this section in the
# Web documentation
```

#### [main]

[main]区段用于配置`SecurityManager`实例和其支撑的各种组件，如[Realm](https://shiro.apache.org/realm.html)。

通过INI配置`SecurityManager`的对象实例及其支撑组件听起来是一件很困难的事情，因为在这里我们只能用键/值对。但通过一些内嵌对象的约定俗成，可以很好地完成这些配置。Shiro利用这些约定俗成来实现一个简单而简明的配置途径。

我们通常喜欢把这种方法称为弱化的依赖注入，尽管不如成熟的Spring/Guice/JBoss XML那么强大，但您会发现它可以做很多事情而且并不复杂。当然，那些强大的其他配置机制也是可用的，但对Shiro来讲并不是必须的。

仅仅吊一下您的胃口，这里是一个简单的使用的`[main]`配置。后续再有详细介绍，但您可能发现您仅凭直觉就可以理解部分含义：

```ini
[main]
sha256Matcher = org.apache.shiro.authc.credential.Sha256CredentialsMatcher

myRealm = com.company.security.shiro.DatabaseRealm
myRealm.connectionTimeout = 30000
myRealm.username = jsmith
myRealm.password = secret
myRealm.credentialsMatcher = $sha256Matcher

securityManager.sessionManager.globalSessionTimeout = 1800000
```

##### 定义对象

想想如下的`[main]`区段里的小节：

```ini
[main]
myRealm = com.company.shiro.realm.MyRealm
...
```

此行实例化了一个`com.company.shiro.realm.MyRealm`对象，并赋值给 **myRealm** 变量。

若实例化的对象实现了`org.apache.shiro.util.Nameable`接口，那么`Nameable.setName`方法将被调用，对象将被命名（本例中为`myRealm`）。

##### 设置对象属性

###### 原始值

简单的原始值属性可以使用下面的等于符号进行设置：

```java
...
myRealm.connectionTimeout = 30000
myRealm.username = jsmith
...
```

这些配置行转换为方法调用：

```java
...
myRealm.setConnectionTimeout(30000);
myRealm.setUsername("jsmith");
...
```

这是如何做到的？这里假定所有对象都是[Java Bean](https://en.wikipedia.org/wiki/JavaBean)兼容的[POJO](https://en.wikipedia.org/wiki/Plain_Old_Java_Object)。

在底层，Shiro默认使用Apache Commons [BeanUtils](http://commons.apache.org/proper/commons-beanutils/)来完成这些繁重的设置属性功能。因此，尽管INI值是文本，BeanUtils知道如何将字符串值转换为适当的基本类型，然后调用相应的JavaBean的setter方法。

###### 引用值

如果您需要设置的值非原始值，而是一个对象呢？您可以使用美元符号（$）来引用一个之前定义的实例。例如：

```java
...
sha256Matcher = org.apache.shiro.authc.credential.Sha256CredentialsMatcher
...
myRealm.credentialsMatcher = $sha256Matcher
...
```

上述就定义了一个名为 **sha256Matcher** 的对象，然后使用BeanUtils在myRealm实例上设置该对象（通过调用`myRealm.setCredentialsMatcher(sha256Matcher)`方法）。

###### 嵌套属性

###### 字节数组值

###### 集合属性

##### 注意事项

###### 顺序问题

###### 覆盖实例

###### 默认SecurityManager

#### [users]

##### 格式

##### 密码加密

#### [roles]

##### 格式

#### [urls]
